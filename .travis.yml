language: node_js
node_js: 6.10

env:
  global:

    - AWS_ACCESS_KEY_ID=AKIAIETZ7UTECKLYJJYQ
    - AWS_DEFAULT_REGION=ap-southeast-2
    - LAMBDA_NAME=sftpToPapertrail
    - LAMBDA_ALIAS=prod

    # AWS_SECRET_ACCESS_KEY
    - secure: ViadDnPh5cylNXx/W+jiSTCOflzfx5vYprZhjjB8Oxibud6b78VpaijBkuW5vSg55Daqm0Br0unmx+3Bu/Yf+NUwtO2m6QJSp+lioJ9ect2lUdBkif/T/OyKFvBe24yNiqVuITZvKZUABVo187N78HYVe34cU4e0w+WSJuMfAy1hx7l9eBdMOqlOWdu+9qYqitimvN0RmluSWf9iCI8a8cDxaE6h+bAZqIwVewwIuek2LrkJbTffKSCikbD8QaSNhUdm/Vpo9mumhegHSFnJYB4pWHOtVoq+aTx3w19hqO0/V+QaZstnBFEtWQDg5qj1GM6jc9jbl/YmEOK46Ng3oUU9SZOJZAkbGzchYSQrfb8mNr676qmH+63yrk1VlpA725YImdgBIAY3WKtlQcwsrrvUwK7hHH+698ZCkFl7xMtGjSPVCxuTh+Y+t8q++ZFF/cFvWfgVfl+gA/Z0iBpOoR+wdHpYdOqIhW1f0yBjQORleg5XOz7Qv5fNRLBm/2J4mZdirVlbVOFfbG7A0Z+2bUge15qdH7aFmRYxmpMqfQaNE6FXuXIJKc7UNRMMBnsWpGxVtEI0oUvwb5ZE271COfKGbyehT0lglkdTDwgk0w5b8OaIkTnvajKSR1mpo+bpZOwOkEVeMpWBNr91wRA6FdjnpOwFID4l4n7N1xFemWA=

cache:
  yarn: true
  directories:
    - node_modules

install: yarn

script:
  - yarn lint
  - yarn test

before_deploy: rm -rf tests .*rc.js

deploy:

  - provider: lambda
    publish: true
    function_name: $LAMBDA_NAME
    region: $AWS_DEFAULT_REGION
    role: arn:aws:iam::873114526714:role/genericLambdaRole
    description: Retrieves log files via SFTP, and logs new entries to Papertrail.
    runtime: nodejs6.10
    timeout: 120
    handler_name: handler
    access_key_id: $AWS_ACCESS_KEY_ID
    secret_access_key:
      secure: UikyNIAcjzs1aDNM+dKag915vmCei0V2jWq8UyFyrc9dmLAE2MuT4wd4ztn073PXKhs84v74aYyndhB9RNVYwKYc8NGoAbLwHM2cXkvMy65/uCfF+/v2mXFzqHPIiIJTI4xJ88a5NoZCbkRwDXPv0HLn/cnjsGBL1AM7OmK7YsOLkDCCyqmhBilWhIGbPqiiJhGWBL6oSg6kdW2TTFyP+dJX52ZVPb68MlBhRX/XqnB2BzBHQKK+OOWO+reziv9sK+l4OjS93iRT+acJc28h4Sc4UMK+YVJPVmiuqYrxCb30lqoJUqLbnGDlCibbdacYypi2p1sEGDJ9dQMOqaOx/oQL9KfvmxCybTjzzVi5W5eXTbKfdPL40ZHVW8/k9x6EVCviV5u6nMfnbL5TOXi9ybunPYQqN0tsfStvUQ2hDrwaDLu6UFBlBtqtSNXmhxqQEFeMgIbxyq+XE2yp0oLaGmLuALc9tRdchq68Lvy6RtpNIA5+V6KJKrcEhokpR5bV1nEug49bflg1rOnDcqcRnsKe3izoloM6mBpmZP22axUd+o1Yh1fK6hLZjEFbswMAiJF+4kbVKyrDTjtSzf3l4vzsz/Fe+mUBZ7Hn44laDkc4W87l0kwgTd4PqBfNTM6wGR0b2/i6j9jnnaEH0QXPmXnCdWsS8tVKrUJMzQhTL2g=
    skip_cleanup: true
    on:
      branch: master

  - provider: npm
    email: tdmalone@gmail.com
    api_key:
      secure: fdg6DUS+Zg3mi3saDcbp4Ns++9B0sgJpSuEDfq/j1InwRYNhJSQmrpzHj1ci2ngmfkEpuKkHTLGC6rRFIO++Q0A0sUblbbEIpBbSgkH2ASzeSTM83d31CK/mq3/hrGSfFa0jo3boZdMf2bQpoaZuWnpe1ZfMjJaWr57BY2VNAFucKyfdgKsb93ZS8AoVREYcePDtPgZ/Ed6A9r/ByCP6TTZhkxltZU4XSpkPMJ0HRG+HNlTzc+DN79Q7PUNMnc4d39p7H4nFzdBuUjyKbpF3G6ppb3w707RKwIUelbo8Q1bEn13al0HWRsramqyQfe6lp25Ej88hSZrHreKT0rVpip7cAJB4adojr4L3h5pRyYixtSvXLIgfy/T+RkQ1eeLrfzjHvviGqF9ajQL34YNyC7BGuBny0RlmjCsH+Z96idgBFi6P6r2ZHpvWkK3UAZzM6veA9K6FetNmOn70nIZBUJWMCxOWPGb221EbqRHlp+CGvC/Xj+1rlrt0aNRZNh6wMCLIS0NZi3Jxy18P0poLjf9ZNcaIB90MH9cNjhdK4FE8JiY0NIoocYQ1vtzcLlq0oj/hi8npcnVupMj6nj+/7t8sw4o9JK6RkK0UOJaPtxQxxSTDUyg8n7VqdW6OblwMfDFKFUnj5C/PIf6lDVmX2QFLw0cM6VeFxuVNz92b0DI=
    skip_cleanup: true
    on:
      branch: master
      tags: true

after_deploy:

  # Set a Lambda alias to the most recently deployed version.
  - pip install awscli --upgrade --user
  - export MOST_RECENT=$(aws lambda list-versions-by-function --function "${LAMBDA_NAME}" --max-items 10000 | node -e "let stdin=''; process.stdin.on('data',(chunk)=>{stdin+=chunk}).on('end',()=>{console.log(JSON.parse(stdin).Versions.pop().Version)})")
  - aws lambda update-alias --function-name "${LAMBDA_NAME}" --name "${LAMBDA_ALIAS}" --function-version "${MOST_RECENT}"

notifications:
  email: false
  slack:
    on_start: always
    rooms:
      - secure: uJ/pVszSOwliIpoc+LBSy/6bs5cAR0GqrycWvYkpmrRdY/Yk96kQtDLKnafYCsJc/veMMOIL3O+KRVnO+tX4BHcNBuVWNowgAaoHCPIqdfzwjG/7m+G6rW1rKmeduc05gAZLlZu4WWWHagin3MHdjtHcTTsL2MhK98K8C/YFkqKOvRWtV+KgU0+/Ij5h5qwofA7qd808Et42rlhAV1Fd//cjcNGw7SRI/IDGnofynoVPNAydT3oGVncPGDnQvd59PVHe41x3dcLwsPG0wgd6NcgBn0g+4mkUtJ+JpnhnNbZYTyeHvCDeOTysH5IvbDqbiq8bS386nBkT1yFYpfRBF4PFv0BDpt5Zt1vkdHmgj1ns6koolTUq6dO+gzLUq52yFKvQXb2jXMUFg/hNGJN7RMq/ke6NuMH/mKVD1iIq3bbZq77b//vV8YPVqwQt0jjvTFF36yS+u6nwVbinQSBpgi9T7kCm6AA24FuVrdN7wV0jcIqY0VGTEeg8CE+NZmdL/SL6Cxl0WwBZu2tnm8N+CwEsuNUPQLZKBkVud9YdAFzNUvE0keorhcRl4ZB6QHYVmFss2WPt7XdusKc/94M30X0HQ1xMgHWha7gtNi0s9HikTVXQjDq9iXQMiS0ZBghGPo/Dx3zSo01eyOVzD0xTLss8Bf4znAlEHfARENjgIFg=
